<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>用ffmpeg合并转换下载的腾讯视频 | Alisa&#39;s Blog</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.a0dbea92.css" as="style"><link rel="preload" href="/assets/js/app.15127fdb.js" as="script"><link rel="preload" href="/assets/js/5.37abb992.js" as="script"><link rel="preload" href="/assets/js/17.68f41123.js" as="script"><link rel="prefetch" href="/assets/js/10.312f88b0.js"><link rel="prefetch" href="/assets/js/11.889608fe.js"><link rel="prefetch" href="/assets/js/12.17973be6.js"><link rel="prefetch" href="/assets/js/13.905ba673.js"><link rel="prefetch" href="/assets/js/14.0fa0b4b5.js"><link rel="prefetch" href="/assets/js/15.f45c3dc0.js"><link rel="prefetch" href="/assets/js/16.2b427eb9.js"><link rel="prefetch" href="/assets/js/18.f5547ca2.js"><link rel="prefetch" href="/assets/js/3.4499fb77.js"><link rel="prefetch" href="/assets/js/4.8944a100.js"><link rel="prefetch" href="/assets/js/6.003ead90.js"><link rel="prefetch" href="/assets/js/7.7fff07b2.js"><link rel="prefetch" href="/assets/js/8.d57777d9.js"><link rel="prefetch" href="/assets/js/9.e6cb7078.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.51db1be4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a0dbea92.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">Alisa's Blog</a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Home</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">Alisa's Blog </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Home</a></li></ul></div></div></div> <div class="content-wrapper"><div class="content-inner"><div id="vuepress-theme-blog__post-layout"><div class="vuepress-blog-theme-content"><div class="content-title">
      用ffmpeg合并转换下载的腾讯视频
    </div> <div class="content__default"><h1 id="问题描述"><a href="#问题描述" class="header-anchor">#</a> 问题描述</h1> <p>作为腾讯视频‘尊贵’的VIP（所以没去看盗版庆余年），想要保存一些比较喜欢的剧集，留待之后观看或作为剪辑素材使用，但目前在腾讯下载的视频是被分割成的数个ts视频片段。
所以研究了一下如何在<code>Mac</code>上合并这些ts文件，并最终转换为mp4文件。</p> <h1 id="所用工具"><a href="#所用工具" class="header-anchor">#</a> 所用工具</h1> <ul><li><a href="https://www.ffmpeg.org/" target="_blank" rel="noopener noreferrer">ffmpeg<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://nodejs.org/en/" target="_blank" rel="noopener noreferrer">Node.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h1 id="操作步骤"><a href="#操作步骤" class="header-anchor">#</a> 操作步骤</h1> <h2 id="_1-安装ffmpeg"><a href="#_1-安装ffmpeg" class="header-anchor">#</a> 1. 安装ffmpeg</h2> <p>Mac上使用<code>homebrew</code>(或者到<a href="https://www.ffmpeg.org/" target="_blank" rel="noopener noreferrer">官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>下载)安装<code>ffmpeg</code></p> <div class="language- extra-class"><pre class="language-text"><code>brew install ffmpeg
</code></pre></div><p>输入上述命令后，按照之后的提示操作即可。安装完成后进入下一步。</p> <h2 id="_2-准备待合并的视频"><a href="#_2-准备待合并的视频" class="header-anchor">#</a> 2. 准备待合并的视频</h2> <p>在Mac上找到腾讯视频下载后的存放位置：</p> <div class="language- extra-class"><pre class="language-text"><code>/Users/你的用户名/Library/Containers/com.tencent.tenvideo/Data/Library/Application Support/Download/video/
</code></pre></div><p>如图所示：除了<code>ad</code>文件夹，每个以<code>.hls</code>结尾的文件夹都包含了一个视频（如一集电视剧），被分割后的所有文件。其中包括一个<code>.m3u8</code>文件及若干分段文件夹，每个分段文件夹又包含30个小的<code>.ts</code>视频片段文件。</p> <p><img src="https://wx4.sinaimg.cn/large/6dc8b1b5ly1gb27xm6bq4j212w0k7na4.jpg" alt=""></p> <p>我们要做的是将所有的<code>.ts</code>文件移动到与<code>.m3u8</code>文件同级的目录下，因为<code>.m3u8</code>文件指定了整个视频的文件名和顺序，但却是相对路径，直接用会找不到文件。</p> <p>这里我用<code>Node.js</code>写了循坏来移动或拷贝所有<code>.ts</code>文件，使用其他语言实现也可。</p> <div class="language- extra-class"><pre class="language-text"><code>const fs = require('fs')
const path = require('path')

try {
  // 获取分段文件夹列表
  const dirList = fs.readdirSync(__dirname)

  dirList.forEach(dirName =&gt; {

    // 分段文件夹路径
    const dirPath = path.join(__dirname, dirName)

    // 获取文件信息，判断是否为文件夹且排除tpt文件夹
    const stats = fs.statSync(dirPath)
    if (stats.isDirectory() &amp;&amp; dirName !== 'tpt') {

      // 获取ts文件列表
      const videoList = fs.readdirSync(dirPath)
      videoList.forEach(videoName =&gt; {

        // ts文件路径
        const videoPath = path.join(dirPath, videoName)

        // 移动文件到与.m3u8同级的目录
        fs.renameSync(videoPath, path.join(__dirname, videoName))

        // 或者拷贝也可以
        // fs.copyFileSync(videoPath, path.join(__dirname, videoName))
      })
    }
  })
} catch (e) {
  console.log(e)
}

</code></pre></div><p>保存上述代码到<code>app.js</code>并将它放到要处理的视频目录下，与<code>.m3u8</code>文件同级。</p> <p>接下来，在命令行中进入到<code>app.js</code>所在的路径，执行：</p> <div class="language- extra-class"><pre class="language-text"><code>node app
</code></pre></div><p>回车后，所有的ts文件就可以完成快速移动了，这样比较大的视频，就算有很多的分段文件夹，也可以很非常快速地搞定，不用手动操作了。</p> <h2 id="_3-ts文件合并及格式转换"><a href="#_3-ts文件合并及格式转换" class="header-anchor">#</a> 3. ts文件合并及格式转换</h2> <p>终于到最后一步了，还是在刚刚的路径下，即<code>.m3u8</code>文件所在路径，在命令行终端中输入以下命令：</p> <div class="language- extra-class"><pre class="language-text"><code>ffmpeg -i .m3u8 -c copy new.mp4
</code></pre></div><p>回车后终于得到了无损完整的视频<code>new.mp4</code>(可以自行更改命名)✌️</p> <h2 id="关于ffmpeg"><a href="#关于ffmpeg" class="header-anchor">#</a> 关于ffmpeg</h2> <p>ffmpeg是一款功能很强大的工具，可以处理音视频，例如格式转换、合成拆分、还能从视频中截图，等等。深入学习的话，感觉能get到很多新技能。
这里用到的ffmpeg命令行参数：</p> <ul><li>-i: input file url 指定输入文件，这里的.m3u8中就指定了输入文件的清单。可以用编辑器打开查看。</li> <li>-c: [:stream_specifier] codec (input/output,per-stream) 应该是指定编码格式相关的</li></ul> <p>这里的<code>-c copy</code>就是直接拷贝原视频的编码格式，最后输出<code>new.mp4</code>文件。</p> <h1 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h1> <p><code>ffmpeg</code>的安装貌似有点费时。</p> <p>开始时看到有些文章里是先用</p> <p><code>ffmpeg -f concat -i files.txt -c copy all.ts</code></p> <p>命令将所有ts文件合并(files.txt指定要合并的ts文件列表)，再使用</p> <p><code>ffmpeg -i all.ts -acodec copy -vcodec copy all.mp4</code></p> <p>将ts文件转换为mp4文件，但最后转换出来的视频放到Premiere中进行处理的时候发现有音画不同步问题，在视频播放器中播放是正常的。</p> <p>虽然命令中视频和音频的编码格式都是<code>copy</code>，但可能音频编码在转换时与视频不同步吧，具体原因需要再研究下。现在一条命令可以完成，暂时也没有这个问题。</p> <p>当然，如果只用一些较短的视频片段的话，直接找到对应镜头的ts文件导入pr也是可以的，最后导出时也能导成mp4文件。</p> <h1 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h1> <ul><li><a href="https://www.ffmpeg.org/" target="_blank" rel="noopener noreferrer">ffmpeg官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 学习更多相关用法</li></ul></div> <!----> <hr> <!----></div> <div class="vuepress-blog-theme-aside"><div class="sticker vuepress-toc"><div class="vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#_1-安装ffmpeg" title="1. 安装ffmpeg">1. 安装ffmpeg</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_2-准备待合并的视频" title="2. 准备待合并的视频">2. 准备待合并的视频</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_3-ts文件合并及格式转换" title="3. ts文件合并及格式转换">3. ts文件合并及格式转换</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#关于ffmpeg" title="关于ffmpeg">关于ffmpeg</a></div></div></div></div></div></div></div> <footer class="footer" data-v-37499e78><ul data-v-37499e78><li class="footer-item" data-v-37499e78>
      @2018 - 2021 By Alisa
    </li> <li class="footer-item" data-v-37499e78><a href="http://www.beian.miit.gov.cn" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-37499e78>京ICP备18061403号-1</a></li> <li class="footer-item" data-v-37499e78>
      Driven -
      <a href="https://vuepress.vuejs.org/" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-37499e78>  Vuepress </a>
      | Theme - Alisa
    </li></ul></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.15127fdb.js" defer></script><script src="/assets/js/5.37abb992.js" defer></script><script src="/assets/js/17.68f41123.js" defer></script>
  </body>
</html>
