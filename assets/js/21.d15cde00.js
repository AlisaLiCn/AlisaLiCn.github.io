(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{326:function(e,t,a){"use strict";a.r(t);var s=a(4),r=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"问题描述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题描述"}},[e._v("#")]),e._v(" 问题描述")]),e._v(" "),a("p",[e._v("作为腾讯视频‘尊贵’的VIP（所以没去看盗版庆余年），想要保存一些比较喜欢的剧集，留待之后观看或作为剪辑素材使用，但目前在腾讯下载的视频是被分割成的数个ts视频片段。\n所以研究了一下如何在"),a("code",[e._v("Mac")]),e._v("上合并这些ts文件，并最终转换为mp4文件。")]),e._v(" "),a("h1",{attrs:{id:"所用工具"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#所用工具"}},[e._v("#")]),e._v(" 所用工具")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://www.ffmpeg.org/",target:"_blank",rel:"noopener noreferrer"}},[e._v("ffmpeg"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://nodejs.org/en/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Node.js"),a("OutboundLink")],1)])]),e._v(" "),a("h1",{attrs:{id:"操作步骤"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#操作步骤"}},[e._v("#")]),e._v(" 操作步骤")]),e._v(" "),a("h2",{attrs:{id:"_1-安装ffmpeg"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装ffmpeg"}},[e._v("#")]),e._v(" 1. 安装ffmpeg")]),e._v(" "),a("p",[e._v("Mac上使用"),a("code",[e._v("homebrew")]),e._v("(或者到"),a("a",{attrs:{href:"https://www.ffmpeg.org/",target:"_blank",rel:"noopener noreferrer"}},[e._v("官网"),a("OutboundLink")],1),e._v("下载)安装"),a("code",[e._v("ffmpeg")])]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("brew install ffmpeg\n")])])]),a("p",[e._v("输入上述命令后，按照之后的提示操作即可。安装完成后进入下一步。")]),e._v(" "),a("h2",{attrs:{id:"_2-准备待合并的视频"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-准备待合并的视频"}},[e._v("#")]),e._v(" 2. 准备待合并的视频")]),e._v(" "),a("p",[e._v("在Mac上找到腾讯视频下载后的存放位置：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("/Users/你的用户名/Library/Containers/com.tencent.tenvideo/Data/Library/Application Support/Download/video/\n")])])]),a("p",[e._v("如图所示：除了"),a("code",[e._v("ad")]),e._v("文件夹，每个以"),a("code",[e._v(".hls")]),e._v("结尾的文件夹都包含了一个视频（如一集电视剧），被分割后的所有文件。其中包括一个"),a("code",[e._v(".m3u8")]),e._v("文件及若干分段文件夹，每个分段文件夹又包含30个小的"),a("code",[e._v(".ts")]),e._v("视频片段文件。")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://wx4.sinaimg.cn/large/6dc8b1b5ly1gb27xm6bq4j212w0k7na4.jpg",alt:""}})]),e._v(" "),a("p",[e._v("我们要做的是将所有的"),a("code",[e._v(".ts")]),e._v("文件移动到与"),a("code",[e._v(".m3u8")]),e._v("文件同级的目录下，因为"),a("code",[e._v(".m3u8")]),e._v("文件指定了整个视频的文件名和顺序，但却是相对路径，直接用会找不到文件。")]),e._v(" "),a("p",[e._v("这里我用"),a("code",[e._v("Node.js")]),e._v("写了循坏来移动或拷贝所有"),a("code",[e._v(".ts")]),e._v("文件，使用其他语言实现也可。")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("const fs = require('fs')\nconst path = require('path')\n\ntry {\n  // 获取分段文件夹列表\n  const dirList = fs.readdirSync(__dirname)\n\n  dirList.forEach(dirName => {\n\n    // 分段文件夹路径\n    const dirPath = path.join(__dirname, dirName)\n\n    // 获取文件信息，判断是否为文件夹且排除tpt文件夹\n    const stats = fs.statSync(dirPath)\n    if (stats.isDirectory() && dirName !== 'tpt') {\n\n      // 获取ts文件列表\n      const videoList = fs.readdirSync(dirPath)\n      videoList.forEach(videoName => {\n\n        // ts文件路径\n        const videoPath = path.join(dirPath, videoName)\n\n        // 移动文件到与.m3u8同级的目录\n        fs.renameSync(videoPath, path.join(__dirname, videoName))\n\n        // 或者拷贝也可以\n        // fs.copyFileSync(videoPath, path.join(__dirname, videoName))\n      })\n    }\n  })\n} catch (e) {\n  console.log(e)\n}\n\n")])])]),a("p",[e._v("保存上述代码到"),a("code",[e._v("app.js")]),e._v("并将它放到要处理的视频目录下，与"),a("code",[e._v(".m3u8")]),e._v("文件同级。")]),e._v(" "),a("p",[e._v("接下来，在命令行中进入到"),a("code",[e._v("app.js")]),e._v("所在的路径，执行：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("node app\n")])])]),a("p",[e._v("回车后，所有的ts文件就可以完成快速移动了，这样比较大的视频，就算有很多的分段文件夹，也可以很非常快速地搞定，不用手动操作了。")]),e._v(" "),a("h2",{attrs:{id:"_3-ts文件合并及格式转换"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-ts文件合并及格式转换"}},[e._v("#")]),e._v(" 3. ts文件合并及格式转换")]),e._v(" "),a("p",[e._v("终于到最后一步了，还是在刚刚的路径下，即"),a("code",[e._v(".m3u8")]),e._v("文件所在路径，在命令行终端中输入以下命令：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("ffmpeg -i .m3u8 -c copy new.mp4\n")])])]),a("p",[e._v("回车后终于得到了无损完整的视频"),a("code",[e._v("new.mp4")]),e._v("(可以自行更改命名)✌️")]),e._v(" "),a("h2",{attrs:{id:"关于ffmpeg"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关于ffmpeg"}},[e._v("#")]),e._v(" 关于ffmpeg")]),e._v(" "),a("p",[e._v("ffmpeg是一款功能很强大的工具，可以处理音视频，例如格式转换、合成拆分、还能从视频中截图，等等。深入学习的话，感觉能get到很多新技能。\n这里用到的ffmpeg命令行参数：")]),e._v(" "),a("ul",[a("li",[e._v("-i: input file url 指定输入文件，这里的.m3u8中就指定了输入文件的清单。可以用编辑器打开查看。")]),e._v(" "),a("li",[e._v("-c: [:stream_specifier] codec (input/output,per-stream) 应该是指定编码格式相关的")])]),e._v(" "),a("p",[e._v("这里的"),a("code",[e._v("-c copy")]),e._v("就是直接拷贝原视频的编码格式，最后输出"),a("code",[e._v("new.mp4")]),e._v("文件。")]),e._v(" "),a("h1",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[e._v("#")]),e._v(" 总结")]),e._v(" "),a("p",[a("code",[e._v("ffmpeg")]),e._v("的安装貌似有点费时。")]),e._v(" "),a("p",[e._v("开始时看到有些文章里是先用")]),e._v(" "),a("p",[a("code",[e._v("ffmpeg -f concat -i files.txt -c copy all.ts")])]),e._v(" "),a("p",[e._v("命令将所有ts文件合并(files.txt指定要合并的ts文件列表)，再使用")]),e._v(" "),a("p",[a("code",[e._v("ffmpeg -i all.ts -acodec copy -vcodec copy all.mp4")])]),e._v(" "),a("p",[e._v("将ts文件转换为mp4文件，但最后转换出来的视频放到Premiere中进行处理的时候发现有音画不同步问题，在视频播放器中播放是正常的。")]),e._v(" "),a("p",[e._v("虽然命令中视频和音频的编码格式都是"),a("code",[e._v("copy")]),e._v("，但可能音频编码在转换时与视频不同步吧，具体原因需要再研究下。现在一条命令可以完成，暂时也没有这个问题。")]),e._v(" "),a("p",[e._v("当然，如果只用一些较短的视频片段的话，直接找到对应镜头的ts文件导入pr也是可以的，最后导出时也能导成mp4文件。")]),e._v(" "),a("h1",{attrs:{id:"参考资料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[e._v("#")]),e._v(" 参考资料")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://www.ffmpeg.org/",target:"_blank",rel:"noopener noreferrer"}},[e._v("ffmpeg官网"),a("OutboundLink")],1),e._v(" 学习更多相关用法")])])])}),[],!1,null,null,null);t.default=r.exports}}]);